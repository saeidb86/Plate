<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚗 سیستم تشخیص پلاک خودرو</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab { display: none; }
        .tab.active { display: block; }
        .tab-button { padding: 10px 20px; cursor: pointer; display: inline-block; }
        .tab-button.active { background-color: #ddd; }
        .result-box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
        .image-preview, .video-preview { max-width: 100%; height: auto; }
        #cameraFeed { max-width: 100%; background-color: #000; }
        button { margin: 5px; padding: 8px 16px; }
        .status { padding: 5px; margin: 5px 0; }
        .connected { background-color: #cfc; }
        .disconnected { background-color: #fcc; }
        .history-item { border-bottom: 1px solid #eee; padding: 5px; }
        .history-success { background-color: #dfd; }
        .history-error { background-color: #fdd; }
        .auto-status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            text-align: center; 
        }
        .auto-active { background-color: #cfc; }
        .auto-inactive { background-color: #ffc; }
    </style>
</head>
<body>
    <div class="tab-buttons">
        <span class="tab-button active" onclick="openTab('imageTab')">تصویر</span>
        <span class="tab-button" onclick="openTab('videoTab')">ویدیو</span>
        <span class="tab-button" onclick="openTab('cameraTab')">دوربین</span>
        <span class="tab-button" onclick="openTab('historyTab')">تاریخچه</span>
    </div>

    <div id="imageTab" class="tab active">
        <h2>آپلود تصویر:</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">ارسال</button>
        
        <div class="result-box">
            <h3>نتایج:</h3>
            <div id="imageResults"></div>
        </div>
        
        <div class="result-box">
            <h3>تصویر پردازش شده:</h3>
            <img id="processedImage" class="image-preview" />
        </div>
    </div>

    <div id="videoTab" class="tab">
        <h2>آپلود ویدیو:</h2>
        <input type="file" id="videoInput" accept="video/*">
        <button onclick="uploadVideo()">ارسال</button>
        
        <div class="result-box">
            <h3>در حال پردازش ویدیو...</h3>
            <video id="processedVideo" class="video-preview" controls></video>
        </div>
        
        <div class="result-box">
            <h3>نتایج تشخیص پلاک:</h3>
            <div id="videoResults"></div>
        </div>
    </div>

    <div id="cameraTab" class="tab">
        <h2>دوربین RTSP:</h2>
        <div class="status" id="cameraStatus">وضعیت: دوربین قطع</div>
        <div class="auto-status auto-active" id="autoStatus">
            سیستم تشخیص خودکار فعال است (هر 5 ثانیه بررسی می‌کند)
        </div>
        
        <div class="result-box">
            <img id="cameraFeed" />
        </div>
        
        <div>
            <button onclick="startCamera()">شروع دوربین</button>
            <button onclick="stopCamera()">توقف دوربین</button>
            <button onclick="captureAndRecognize()">تشخیص پلاک</button>
        </div>
        
        <div class="result-box">
            <h3>نتایج:</h3>
            <div id="cameraResults"></div>
        </div>
        
        <div class="result-box">
            <h3>تصویر پردازش شده:</h3>
            <img id="processedCameraImage" class="image-preview" />
        </div>
    </div>

    <div id="historyTab" class="tab">
        <h2>تاریخچه تشخیص پلاک:</h2>
        <button onclick="loadDetectionHistory()">بارگذاری تاریخچه</button>
        <button onclick="clearDetectionHistory()">پاک کردن تاریخچه</button>
        
        <div class="result-box">
            <h3>تاریخچه ارسال به API:</h3>
            <div id="detectionHistory"></div>
        </div>
    </div>

    <script>
        let cameraWs = null;
        let autoInterval = null;
        let frameRefreshInterval = null;

        function openTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
            
            if (tabName !== 'cameraTab') {
                stopCamera();
            }
            
            if (tabName === 'historyTab') {
                loadDetectionHistory();
            }
        }

        function updateCameraStatus(connected) {
            const statusElement = document.getElementById('cameraStatus');
            statusElement.textContent = `وضعیت: ${connected ? 'دوربین متصل' : 'دوربین قطع'}`;
            statusElement.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        async function startCamera() {
            try {
                stopCamera(); // اطمینان از قطع اتصالات قبلی
                updateCameraStatus(false);
                
                // تست اتصال به دوربین
                const testRes = await fetch('/test_rtsp_connection');
                if (!testRes.ok) throw new Error("اتصال به دوربین ناموفق بود");
                
                // اتصال WebSocket برای استریم زنده
                cameraWs = new WebSocket(`ws://${window.location.host}/ws`);
                
                cameraWs.onmessage = (event) => {
                    const blob = new Blob([event.data], {type: 'image/jpeg'});
                    const url = URL.createObjectURL(blob);
                    document.getElementById('cameraFeed').src = url;
                    updateCameraStatus(true);
                };
                
                cameraWs.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateCameraStatus(false);
                };
                
                cameraWs.onclose = () => {
                    updateCameraStatus(false);
                };
                
            } catch (err) {
                console.error("Error:", err);
                updateCameraStatus(false);
                alert("خطا در اتصال به دوربین: " + err.message);
            }
        }

        function stopCamera() {
            if (cameraWs) {
                cameraWs.close();
                cameraWs = null;
            }
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
            }
            updateCameraStatus(false);
            document.getElementById('cameraFeed').src = '';
        }

        async function captureAndRecognize() {
            try {
                const startTime = performance.now();
                const response = await fetch('/recognize_camera');
                const data = await response.json();
                
                const endTime = performance.now();
                console.log(`تشخیص در ${(endTime - startTime).toFixed(1)} میلی‌ثانیه انجام شد`);
                
                displayResults(data, 'cameraResults', 'processedCameraImage');
            } catch (err) {
                console.error("Error:", err);
                alert("خطا در تشخیص پلاک");
            }
        }

        function displayResults(data, resultsElementId, imageElementId) {
            const resultsDiv = document.getElementById(resultsElementId);
            const imageElement = document.getElementById(imageElementId);
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = data.results.map(result => 
                    `<div>پلاک: ${result.text} (اعتماد: ${(result.confidence * 100).toFixed(1)}%)</div>`
                ).join('') || '<div>پلاکی تشخیص داده نشد</div>';
                
                if (data.image) {
                    imageElement.src = `data:image/jpeg;base64,${data.image}`;
                }
            } else {
                resultsDiv.innerHTML = `<div>خطا: ${data.detail || 'خطای ناشناخته'}</div>`;
            }
        }

        async function loadDetectionHistory() {
            try {
                const response = await fetch('/detection_history');
                const data = await response.json();
                
                const historyDiv = document.getElementById('detectionHistory');
                historyDiv.innerHTML = '';
                
                if (data.history && data.history.length > 0) {
                    data.history.reverse().forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `history-item ${item.sent ? 'history-success' : 'history-error'}`;
                        
                        const time = new Date(item.timestamp).toLocaleString('fa-IR');
                        itemDiv.innerHTML = `
                            <div><strong>پلاک:</strong> ${item.plate}</div>
                            <div><strong>زمان:</strong> ${time}</div>
                            <div><strong>وضعیت:</strong> ${item.sent ? 'ارسال موفق' : 'ارسال ناموفق'}</div>
                            ${item.error ? `<div><strong>خطا:</strong> ${item.error}</div>` : ''}
                        `;
                        
                        historyDiv.appendChild(itemDiv);
                    });
                } else {
                    historyDiv.innerHTML = '<div>هیچ تاریخچه‌ای موجود نیست</div>';
                }
            } catch (err) {
                console.error("Error loading history:", err);
                document.getElementById('detectionHistory').innerHTML = '<div>خطا در بارگذاری تاریخچه</div>';
            }
        }

        async function clearDetectionHistory() {
            if (confirm('آیا از پاک کردن تاریخچه اطمینان دارید؟')) {
                try {
                    // در اینجا می‌توانید یک API برای پاک کردن تاریخچه اضافه کنید
                    // فعلاً فقط صفحه را رفرش می‌کند
                    loadDetectionHistory();
                } catch (err) {
                    console.error("Error clearing history:", err);
                    alert("خطا در پاک کردن تاریخچه");
                }
            }
        }

        // توابع uploadImage و uploadVideo مانند قبل باقی می‌مانند
        // ...
    </script>
</body>
</html>