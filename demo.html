<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚗 سیستم تشخیص پلاک خودرو</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab { display: none; }
        .tab.active { display: block; }
        .tab-button { padding: 10px 20px; cursor: pointer; display: inline-block; }
        .tab-button.active { background-color: #ddd; }
        .result-box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
        .image-preview, .video-preview { max-width: 100%; height: auto; }
        #cameraFeed { max-width: 100%; background-color: #000; }
        button { margin: 5px; padding: 8px 16px; }
        .status { padding: 5px; margin: 5px 0; }
        .connected { background-color: #cfc; }
        .disconnected { background-color: #fcc; }
    </style>
</head>
<body>
    <div class="tab-buttons">
        <span class="tab-button active" onclick="openTab('imageTab')">تصویر</span>
        <span class="tab-button" onclick="openTab('videoTab')">ویدیو</span>
        <span class="tab-button" onclick="openTab('cameraTab')">دوربین</span>
    </div>

    <div id="imageTab" class="tab active">
        <h2>آپلود تصویر:</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">ارسال</button>
        
        <div class="result-box">
            <h3>نتایج:</h3>
            <div id="imageResults"></div>
        </div>
        
        <div class="result-box">
            <h3>تصویر پردازش شده:</h3>
            <img id="processedImage" class="image-preview" />
        </div>
    </div>

    <div id="videoTab" class="tab">
        <h2>آپلود ویدیو:</h2>
        <input type="file" id="videoInput" accept="video/*">
        <button onclick="uploadVideo()">ارسال</button>
        
        <div class="result-box">
            <h3>در حال پردازش ویدیو...</h3>
            <video id="processedVideo" class="video-preview" controls></video>
        </div>
        
        <div class="result-box">
            <h3>نتایج تشخیص پلاک:</h3>
            <div id="videoResults"></div>
        </div>
    </div>

    <div id="cameraTab" class="tab">
        <h2>دوربین RTSP:</h2>
        <div class="status" id="cameraStatus">وضعیت: دوربین قطع</div>
        
        <div class="result-box">
            <img id="cameraFeed" />
        </div>
        
        <div>
            <button onclick="startCamera()">شروع دوربین</button>
            <button onclick="stopCamera()">توقف دوربین</button>
            <button onclick="captureAndRecognize()">تشخیص پلاک</button>
            <button onclick="toggleContinuousMode()">حالت تشخیص خودکار</button>
        </div>
        
        <div class="result-box">
            <h3>نتایج:</h3>
            <div id="cameraResults"></div>
        </div>
        
        <div class="result-box">
            <h3>تصویر پردازش شده:</h3>
            <img id="processedCameraImage" class="image-preview" />
        </div>
    </div>

    <script>
        let cameraWs = null;
        let autoInterval = null;
        let frameRefreshInterval = null;

        function openTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
            
            if (tabName !== 'cameraTab') {
                stopCamera();
            }
        }

        function updateCameraStatus(connected) {
            const statusElement = document.getElementById('cameraStatus');
            statusElement.textContent = `وضعیت: ${connected ? 'دوربین متصل' : 'دوربین قطع'}`;
            statusElement.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        async function startCamera() {
            try {
                stopCamera(); // اطمینان از قطع اتصالات قبلی
                updateCameraStatus(false);
                
                // تست اتصال به دوربین
                const testRes = await fetch('/test_rtsp_connection');
                if (!testRes.ok) throw new Error("اتصال به دوربین ناموفق بود");
                
                // اتصال WebSocket برای استریم زنده
                cameraWs = new WebSocket(`ws://${window.location.host}/ws`);
                
                cameraWs.onmessage = (event) => {
                    const blob = new Blob([event.data], {type: 'image/jpeg'});
                    const url = URL.createObjectURL(blob);
                    document.getElementById('cameraFeed').src = url;
                    updateCameraStatus(true);
                };
                
                cameraWs.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateCameraStatus(false);
                };
                
                cameraWs.onclose = () => {
                    updateCameraStatus(false);
                };
                
            } catch (err) {
                console.error("Error:", err);
                updateCameraStatus(false);
                alert("خطا در اتصال به دوربین: " + err.message);
            }
        }

        function stopCamera() {
            if (cameraWs) {
                cameraWs.close();
                cameraWs = null;
            }
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
            }
            updateCameraStatus(false);
            document.getElementById('cameraFeed').src = '';
        }

        async function captureAndRecognize() {
            try {
                const startTime = performance.now();
                const response = await fetch('/recognize_camera');
                const data = await response.json();
                
                const endTime = performance.now();
                console.log(`تشخیص در ${(endTime - startTime).toFixed(1)} میلی‌ثانیه انجام شد`);
                
                displayResults(data, 'cameraResults', 'processedCameraImage');
            } catch (err) {
                console.error("Error:", err);
                alert("خطا در تشخیص پلاک");
            }
        }

        function toggleContinuousMode() {
            const button = document.querySelector('button[onclick="toggleContinuousMode()"]');
            
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                button.textContent = 'حالت تشخیص خودکار';
            } else {
                button.textContent = 'توقف تشخیص خودکار';
                autoInterval = setInterval(() => {
                    if (document.getElementById('cameraTab').classList.contains('active')) {
                        captureAndRecognize();
                    }
                }, 1000); // هر 1 ثانیه یکبار تشخیص
            }
        }

        function displayResults(data, resultsElementId, imageElementId) {
            const resultsDiv = document.getElementById(resultsElementId);
            const imageElement = document.getElementById(imageElementId);
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = data.results.map(result => 
                    `<div>پلاک: ${result.text} (اعتماد: ${(result.confidence * 100).toFixed(1)}%)</div>`
                ).join('') || '<div>پلاکی تشخیص داده نشد</div>';
                
                if (data.image) {
                    imageElement.src = `data:image/jpeg;base64,${data.image}`;
                }
            } else {
                resultsDiv.innerHTML = `<div>خطا: ${data.detail || 'خطای ناشناخته'}</div>`;
            }
        }

        // توابع uploadImage و uploadVideo مانند قبل باقی می‌مانند
        // ...
    </script>
</body>
</html>