<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš— Ø³ÛŒØ³ØªÙ… ØªØ´Ø®ÛŒØµ Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab { display: none; }
        .tab.active { display: block; }
        .tab-button { padding: 10px 20px; cursor: pointer; display: inline-block; }
        .tab-button.active { background-color: #ddd; }
        .result-box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
        .image-preview, .video-preview { max-width: 100%; height: auto; }
        #cameraFeed { max-width: 100%; background-color: #000; }
        button { margin: 5px; padding: 8px 16px; }
        .status { padding: 5px; margin: 5px 0; }
        .connected { background-color: #cfc; }
        .disconnected { background-color: #fcc; }
    </style>
</head>
<body>
    <div class="tab-buttons">
        <span class="tab-button active" onclick="openTab('imageTab')">ØªØµÙˆÛŒØ±</span>
        <span class="tab-button" onclick="openTab('videoTab')">ÙˆÛŒØ¯ÛŒÙˆ</span>
        <span class="tab-button" onclick="openTab('cameraTab')">Ø¯ÙˆØ±Ø¨ÛŒÙ†</span>
    </div>

    <div id="imageTab" class="tab active">
        <h2>Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±:</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">Ø§Ø±Ø³Ø§Ù„</button>
        
        <div class="result-box">
            <h3>Ù†ØªØ§ÛŒØ¬:</h3>
            <div id="imageResults"></div>
        </div>
        
        <div class="result-box">
            <h3>ØªØµÙˆÛŒØ± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡:</h3>
            <img id="processedImage" class="image-preview" />
        </div>
    </div>

    <div id="videoTab" class="tab">
        <h2>Ø¢Ù¾Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ:</h2>
        <input type="file" id="videoInput" accept="video/*">
        <button onclick="uploadVideo()">Ø§Ø±Ø³Ø§Ù„</button>
        
        <div class="result-box">
            <h3>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆÛŒØ¯ÛŒÙˆ...</h3>
            <video id="processedVideo" class="video-preview" controls></video>
        </div>
        
        <div class="result-box">
            <h3>Ù†ØªØ§ÛŒØ¬ ØªØ´Ø®ÛŒØµ Ù¾Ù„Ø§Ú©:</h3>
            <div id="videoResults"></div>
        </div>
    </div>

    <div id="cameraTab" class="tab">
        <h2>Ø¯ÙˆØ±Ø¨ÛŒÙ† RTSP:</h2>
        <div class="status" id="cameraStatus">ÙˆØ¶Ø¹ÛŒØª: Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‚Ø·Ø¹</div>
        
        <div class="result-box">
            <img id="cameraFeed" />
        </div>
        
        <div>
            <button onclick="startCamera()">Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
            <button onclick="stopCamera()">ØªÙˆÙ‚Ù Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
            <button onclick="captureAndRecognize()">ØªØ´Ø®ÛŒØµ Ù¾Ù„Ø§Ú©</button>
            <button onclick="toggleContinuousMode()">Ø­Ø§Ù„Øª ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±</button>
        </div>
        
        <div class="result-box">
            <h3>Ù†ØªØ§ÛŒØ¬:</h3>
            <div id="cameraResults"></div>
        </div>
        
        <div class="result-box">
            <h3>ØªØµÙˆÛŒØ± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡:</h3>
            <img id="processedCameraImage" class="image-preview" />
        </div>
    </div>

    <script>
        let cameraWs = null;
        let autoInterval = null;
        let frameRefreshInterval = null;

        function openTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
            
            if (tabName !== 'cameraTab') {
                stopCamera();
            }
        }

        function updateCameraStatus(connected) {
            const statusElement = document.getElementById('cameraStatus');
            statusElement.textContent = `ÙˆØ¶Ø¹ÛŒØª: ${connected ? 'Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù…ØªØµÙ„' : 'Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‚Ø·Ø¹'}`;
            statusElement.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        async function startCamera() {
            try {
                stopCamera(); // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„Ø§Øª Ù‚Ø¨Ù„ÛŒ
                updateCameraStatus(false);
                
                // ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†
                const testRes = await fetch('/test_rtsp_connection');
                if (!testRes.ok) throw new Error("Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");
                
                // Ø§ØªØµØ§Ù„ WebSocket Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ±ÛŒÙ… Ø²Ù†Ø¯Ù‡
                cameraWs = new WebSocket(`ws://${window.location.host}/ws`);
                
                cameraWs.onmessage = (event) => {
                    const blob = new Blob([event.data], {type: 'image/jpeg'});
                    const url = URL.createObjectURL(blob);
                    document.getElementById('cameraFeed').src = url;
                    updateCameraStatus(true);
                };
                
                cameraWs.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateCameraStatus(false);
                };
                
                cameraWs.onclose = () => {
                    updateCameraStatus(false);
                };
                
            } catch (err) {
                console.error("Error:", err);
                updateCameraStatus(false);
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†: " + err.message);
            }
        }

        function stopCamera() {
            if (cameraWs) {
                cameraWs.close();
                cameraWs = null;
            }
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
            }
            updateCameraStatus(false);
            document.getElementById('cameraFeed').src = '';
        }

        async function captureAndRecognize() {
            try {
                const startTime = performance.now();
                const response = await fetch('/recognize_camera');
                const data = await response.json();
                
                const endTime = performance.now();
                console.log(`ØªØ´Ø®ÛŒØµ Ø¯Ø± ${(endTime - startTime).toFixed(1)} Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯`);
                
                displayResults(data, 'cameraResults', 'processedCameraImage');
            } catch (err) {
                console.error("Error:", err);
                alert("Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ Ù¾Ù„Ø§Ú©");
            }
        }

        function toggleContinuousMode() {
            const button = document.querySelector('button[onclick="toggleContinuousMode()"]');
            
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                button.textContent = 'Ø­Ø§Ù„Øª ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±';
            } else {
                button.textContent = 'ØªÙˆÙ‚Ù ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±';
                autoInterval = setInterval(() => {
                    if (document.getElementById('cameraTab').classList.contains('active')) {
                        captureAndRecognize();
                    }
                }, 1000); // Ù‡Ø± 1 Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ©Ø¨Ø§Ø± ØªØ´Ø®ÛŒØµ
            }
        }

        function displayResults(data, resultsElementId, imageElementId) {
            const resultsDiv = document.getElementById(resultsElementId);
            const imageElement = document.getElementById(imageElementId);
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = data.results.map(result => 
                    `<div>Ù¾Ù„Ø§Ú©: ${result.text} (Ø§Ø¹ØªÙ…Ø§Ø¯: ${(result.confidence * 100).toFixed(1)}%)</div>`
                ).join('') || '<div>Ù¾Ù„Ø§Ú©ÛŒ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯</div>';
                
                if (data.image) {
                    imageElement.src = `data:image/jpeg;base64,${data.image}`;
                }
            } else {
                resultsDiv.innerHTML = `<div>Ø®Ø·Ø§: ${data.detail || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}</div>`;
            }
        }

        // ØªÙˆØ§Ø¨Ø¹ uploadImage Ùˆ uploadVideo Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯
        // ...
    </script>
</body>
</html>